pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Build') {
            environment {
                PY_WRAPPER = '/opt/virtualenvs/solefi/bin/python3'
                env = 'staging'
            }
            steps {
                sh '. /opt/virtualenvs/solefi/bin/activate'
                sh 'sudo cp /home/christopher/solefi-staging-django-env ./solefi_cms/.env'
                sh '$PY_WRAPPER -m pip install -r requirements.txt'
                sh '$PY_WRAPPER manage.py migrate'
                sh '$PY_WRAPPER manage.py collectstatic --noinput'
            }
        }
        stage('Deploy') {
            steps {
                sh 'sudo chmod -R 777 /hdd/apps/staging/'
                sh 'sudo rm -rf /hdd/apps/staging/solefi-cms'
                sh 'sudo mkdir /hdd/apps/staging/solefi-cms'
                sh 'sudo cp -r ./* /hdd/apps/staging/solefi-cms'
            }
        }
        stage('Restart Supervisor') {
            steps {
                sh 'sudo supervisorctl reread'
                sh 'sudo supervisorctl update'
                sh 'sudo supervisorctl restart solefi_cms_staging_0'
                sh 'sudo supervisorctl restart solefi_cms_staging_1'
            }
        }
    }
}